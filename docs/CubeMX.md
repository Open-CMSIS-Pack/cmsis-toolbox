# Work with CubeMX

<!-- markdownlint-disable MD009 -->
<!-- markdownlint-disable MD013 -->
<!-- markdownlint-disable MD036 -->

[**CMSIS-Toolbox**](README.md) **> Work with CubeMX**

This chapter explains how to use [STM32CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html) (or just CubeMX) with the CMSIS-Toolbox to manage device and board configuration.

**Chapter Contents:**

- [Work with CubeMX](#work-with-cubemx)
  - [Overview](#overview)
  - [Simple Project](#simple-project)
  - [Add RTOS](#add-rtos)
  - [Add Linker Script?](#add-linker-script)
  - [Work with Board Layer](#work-with-board-layer)
  - [TrustZone or Multicore Project](#trustzone-or-multicore-project)
  - [CubeMX Context Mapping](#cubemx-context-mapping)

## Overview

[STM32CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html) is a graphical tool for configuration of a STM32 device or board. It generates C code for project and peripheral initialization based on user settings. CubeMX interacts with the CMSIS-Toolbox  using the [generic interface for generators](build-operation.md#generator-integration).

The `component: Device:CubeMX` connects a *csolution project* to CubeMX. This component imports the CubeMX generated files for a selected `device:` or `board:` using the `*.cgen.yml` file. This `*.cgen.yml` file is similar to a [software layer](build-overview.md#software-layers) but managed by CubeMX and should be not modified directly.

## Simple Project

Below is a simple project that just adds the CubeMX generated components.

>**Note:**  
>
> The required packs are listed on [www.keil.arm.com/boards](https://www.keil.arm.com/boards/) and [www.keil.arm.com/devices](https://www.keil.arm.com/devices/).

**File: `CubeMX.csolution.yml`**

```yml
solution:
  created-for: CMSIS-Toolbox@2.3.0
  description: Simple CubeMX example
  cdefault:                                   # use toolchain default settings
  compiler: AC6                               # select toolchain

# it is recommended to list the pack or packs that define the device or board used in the csolution.yml file
  packs:
    - pack: ARM::CMSIS@6.0.0
    - pack: Keil::B-U585I-IOT02A_BSP
    - pack: Keil::STM32U5xx_DFP@>=3.0.0-0
    
  target-types:
    - type: MyBoard                           # My evaluation kit
      board: B-U585I-IOT02A                   # Board name as defined by the pack

  build-types:                                # defines toolchain options for 'debug' and 'release'
    - type: Debug
      debug: on
      optimize: none

    - type: Release
      debug: off
      optimize: balanced

  projects:                                   # list related projects
    - project: ./CubeMX.cproject.yml
```

**File: `CubeMX.cproject.yml`**

```yml
project:
  components:
    - component: CMSIS:CORE                   # CMSIS-Core component is required
    - component: Device:CubeMX                # Component that connects to CubeMX    
```

Such a project cannot be directly generated as initially the `*.cgen.yml` file is missing. It requires to run the CubeMX generator.  Before you start, you may need to [`install missing packs`](build-tools.md#install-missing-packs).

1. Identify the required generator and the directory where the generated files are stored with:
   
   ```bash
   >csolution CubeMX.csolution.yml list generators --verbose
   CubeMX (Global Registered Generator)    # generator name
     base-dir: STM32CubeMX/MyBoard         # directory for generated files
       context: CubeMX.Debug+MyBoard       # list of context that uses this directory
       context: CubeMX.Release+MyBoard 
   ```

2. Using the above information to run the generator using this command:

   ```bash
   >csolution CubeMX.csolution.yml run --generator CubeMX --context CubeMX.Debug+MyBoard
   ```

   It starts CubeMX and passes the information about the selected board and the select toolchain. As the project selects a board, CubeMX imports the default configuration for the evaluation kit. In CubeMX just click the button `GENERATE CODE`. The generated files will be stored in the directory `STM32CubeMX/MyBoard`.

3. Build the project using this command:
 
   ```bash
   >cbuild CubeMX.csolution.yml --update-rte
   ```

>**Note:**
>
> You may run the CubeMX generator any time to change the configuration setting of your device or board.

**Content of: `STM32CubeMX/MyBoard/CubeMX.cgen.yml`**

The file `*.cgen.yml` lists the files and settings that are generated by CubeMX and imported in the *csolution project*. The files under `group: CubeMX` may be modified by the user to implement the application specific features.  In the file `*.cproject.yml` additional [user files](YML-Input-Format.md#files) can be added.

```yml
generator-import:
  for-device: STM32U585AIIx
  for-board: B-U585I-IOT02A
  define:
    - USE_FULL_LL_DRIVER
    - USE_HAL_DRIVER
    - STM32U585xx
  add-path:
    - ./STM32CubeMX/Drivers/STM32U5xx_HAL_Driver/Inc
    - ./STM32CubeMX/Drivers/STM32U5xx_HAL_Driver/Inc/Legacy
    - ./STM32CubeMX/Drivers/CMSIS/Device/ST/STM32U5xx/Include
    - ./STM32CubeMX/Inc
    - ./MX_Device/CubeMX
  groups:
    - group: CubeMX
      files:
        - file: ./STM32CubeMX/Src/main.c
        - file: ./STM32CubeMX/Src/stm32u5xx_it.c
        - file: ./STM32CubeMX/Src/stm32u5xx_hal_msp.c
        - file: ./STM32CubeMX/MDK-ARM/startup_stm32u585xx.s
        - file: ./STM32CubeMX/Src/system_stm32u5xx.c
    - group: STM32 HAL Driver
      files:
        - file: ./STM32CubeMX/Drivers/STM32U5xx_HAL_Driver/Src/stm32u5xx_ll_utils.c
        - file: ./STM32CubeMX/Drivers/STM32U5xx_HAL_Driver/Src/stm32u5xx_ll_exti.c
            :
        - file: ./STM32CubeMX/Drivers/STM32U5xx_HAL_Driver/Src/stm32u5xx_hal_pcd_ex.c
        - file: ./STM32CubeMX/Drivers/STM32U5xx_HAL_Driver/Src/stm32u5xx_ll_usb.c
```

## Add RTOS

Describe the steps to add an RTOS Kernel.

## Add Linker Script?

Should we add information about a linker script?

## Work with Board Layer

What needs to be considered when working with layers, make a layer out of the configuration.

## TrustZone or Multicore Project

Explain what is different when creating a TrustZone or Multicore Project

## CubeMX Context Mapping

Explain how to create a project for the STM32H7S series.
